<UserControl x:Class="Takt.Fluent.Views.Logistics.Visits.WelcomeSignView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:Takt.Fluent.Extensions"
             xmlns:helpers="clr-namespace:Takt.Fluent.Helpers"
             xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
             xmlns:fa="clr-namespace:FontAwesome.Sharp;assembly=FontAwesome.Sharp"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d"
             d:DesignHeight="1080"
             d:DesignWidth="1920">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <helpers:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <helpers:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        
        <!-- 红色背景色 -->
        <SolidColorBrush x:Key="WelcomeRedBackground" Color="#DC143C"/>
        <!-- 黄色文字 -->
        <SolidColorBrush x:Key="WelcomeYellowText" Color="#FFD700"/>
        
        <!-- 欢迎牌样式 - 红色背景矩形，全屏显示 -->
        <Style x:Key="WelcomeCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource WelcomeRedBackground}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
        </Style>

        <!-- 顶部标题样式 - 热烈欢迎 -->
        <Style x:Key="WelcomeHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="40"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource WelcomeYellowText}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,0,60"/>
        </Style>

        <!-- 公司名称样式 - FontSize由代码动态设置，不在样式中设置默认值 -->
        <Style x:Key="WelcomeCompanyStyle" TargetType="TextBlock">
            <!-- FontSize 由代码动态设置，不设置默认值 -->
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource WelcomeYellowText}"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <!-- 部门样式 - FontSize由代码动态设置，不在样式中设置默认值 -->
        <Style x:Key="WelcomeDeptStyle" TargetType="TextBlock">
            <!-- FontSize 由代码动态设置，不设置默认值 -->
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="Foreground" Value="{StaticResource WelcomeYellowText}"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <!-- 人员+职务样式 - FontSize由代码动态设置，不在样式中设置默认值 -->
        <Style x:Key="WelcomePersonStyle" TargetType="TextBlock">
            <!-- FontSize 由代码动态设置，不设置默认值 -->
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="Foreground" Value="{StaticResource WelcomeYellowText}"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
        </Style>

        <!-- 底部标题样式 - 莅临指导 -->
        <Style x:Key="WelcomeFooterStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="40"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource WelcomeYellowText}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,60,0,0"/>
        </Style>
    </UserControl.Resources>

    <!-- 主容器：正常模式下包含 MainGrid，全屏模式下 MainGrid 会被移动到全屏窗口 -->
    <Grid x:Name="MainContainerGrid">
        <Grid Background="Black" x:Name="MainGrid" ContextMenuOpening="MainGrid_ContextMenuOpening">
        <!-- 右键菜单 - 使用与 MainWindow 用户信息菜单相同的 Fluent 样式 -->
        <Grid.ContextMenu>
            <ContextMenu x:Name="MainContextMenu" 
                         Style="{DynamicResource FluentContextMenuStyle}"
                         DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                <!-- 全屏菜单项 -->
                <MenuItem x:Name="FullScreenMenuItem"
                          Command="{Binding ToggleFullScreenCommand}"
                          Style="{DynamicResource FluentMenuItemInfoStyle}">
                    <MenuItem.Header>
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{local:Localization Key=common.button.fullscreen}"/>
                                    <Style.Triggers>
                                        <!-- 修复：直接绑定 IsFullScreen，因为 ContextMenu 的 DataContext 已经设置为 ViewModel -->
                                        <DataTrigger Binding="{Binding IsFullScreen}" Value="True">
                                            <Setter Property="Text" Value="{local:Localization Key=common.button.restore}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </MenuItem.Header>
                    <MenuItem.Icon>
                        <fa:IconBlock x:Name="FullScreenMenuItemIcon"
                                      Icon="Expand"
                                      IconFont="Solid"
                                      Width="16"
                                      Height="16"/>
                    </MenuItem.Icon>
                </MenuItem>
                
                <!-- 编辑菜单项 -->
                <MenuItem x:Name="EditMenuItem"
                          Command="{Binding ToggleEditModeCommand}"
                          Style="{DynamicResource FluentMenuItemInfoStyle}">
                    <MenuItem.Header>
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{local:Localization Key=common.button.edit}"/>
                                    <Style.Triggers>
                                        <!-- 修复：直接绑定 IsEditMode，因为 ContextMenu 的 DataContext 已经设置为 ViewModel -->
                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                            <Setter Property="Text" Value="{local:Localization Key=common.button.exit}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </MenuItem.Header>
                    <MenuItem.Icon>
                        <fa:IconBlock Icon="Edit"
                                      IconFont="Solid"
                                      Width="16"
                                      Height="16"/>
                    </MenuItem.Icon>
                </MenuItem>
            </ContextMenu>
        </Grid.ContextMenu>
        
        <!-- 辅助线已改用 AdornerLayer 实现，不再需要 Canvas -->
        
        <!-- 随行人员信息欢迎牌背景 - 全屏显示红色背景 -->
        <Border Style="{StaticResource WelcomeCardStyle}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        
        <!-- Header（顶部）- 相对于整个视口定位 -->
        <TextBlock Text="{local:Localization Key=logistics.welcomesign.header}" 
                   Style="{StaticResource WelcomeHeaderStyle}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Top"
                   Margin="0,0,0,0"
                   Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        
        <!-- 公司名称 - 已移动到ItemsControl内部，不再使用单独的CompanyTextBlock -->
        <!-- 公司名称现在通过ItemsControl中的CompanyTextBlockItem显示，支持多公司合并显示 -->
        <!-- <TextBlock x:Name="CompanyTextBlock"
                   Text="{Binding CurrentEntourage.VisitingCompany}" 
                   Style="{StaticResource WelcomeCompanyStyle}"
                   HorizontalAlignment="Left"
                   VerticalAlignment="Top"
                   Margin="20,80,20,0"
                   Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}"/> -->
        
        <!-- 随行人员详情列表 - 相对于整个视口定位 -->
        <!-- 使用处理后的显示项列表，支持没有部门的人员优先显示和相同部门合并 -->
        <ItemsControl x:Name="EntourageDetailsItemsControl"
                      ItemsSource="{Binding CurrentVisitingDisplayItems}" 
                      HorizontalAlignment="Left"
                      VerticalAlignment="Top"
                      Margin="0,160,0,0"
                      Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <StackPanel HorizontalAlignment="Left" 
                                Margin="0,0,0,0">
                        <!-- 公司名称 - 只在ShowCompany为True时显示（公司名称行），距离Header 20px，左边距20px -->
                        <!-- Margin由代码动态设置，不在这里硬编码 -->
                        <TextBlock x:Name="CompanyTextBlockItem"
                                   Text="{Binding VisitingCompany}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource WelcomeCompanyStyle}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <!-- ShowCompany为True时显示公司名称 -->
                                        <DataTrigger Binding="{Binding ShowCompany}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <!-- 部门名称 - 只在有部门名称且职务和人员都为空时显示（部门名称行），对齐公司并缩进20px（左边距40px），下边距40px -->
                        <!-- Margin由代码动态设置，不在这里硬编码 -->
                        <TextBlock x:Name="DeptTextBlock"
                                   Text="{Binding VisitDept}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource WelcomeDeptStyle}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <!-- 有部门名称且职务和人员都为空时显示部门名称（部门名称行），且不是公司名称行 -->
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding ShowDept}" Value="True"/>
                                                <Condition Binding="{Binding VisitPost, Converter={StaticResource StringToVisibilityConverter}}" Value="Collapsed"/>
                                                <Condition Binding="{Binding VisitingMembers, Converter={StaticResource StringToVisibilityConverter}}" Value="Collapsed"/>
                                                <Condition Binding="{Binding ShowCompany}" Value="False"/>
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <!-- 职务+人员 - 只在职务或人员不为空时显示 -->
                        <!-- **关键规则**：
                             1. 没有部门的人员：对齐公司并缩进20px（左边距40px），下边距40px
                             2. 有部门的人员：对齐部门并缩进20px（左边距60px），下边距40px -->
                        <!-- Margin由代码动态设置，不在这里硬编码 -->
                        <!-- 使用InlineUIContainer实现职务和人员之间的精确60px间隔 -->
                        <TextBlock x:Name="PersonPostTextBlock">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource WelcomePersonStyle}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <!-- 职务或人员不为空时显示 -->
                                        <DataTrigger Binding="{Binding VisitPost, Converter={StaticResource StringToVisibilityConverter}}" Value="Visible">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding VisitingMembers, Converter={StaticResource StringToVisibilityConverter}}" Value="Visible">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                            <Run Text="{Binding VisitPost, Mode=OneWay}"/>
                            <InlineUIContainer>
                                <Rectangle Width="60" Height="1" Fill="Transparent"/>
                            </InlineUIContainer>
                            <Run Text="{Binding VisitingMembers, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
            <ItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <!-- 每个随行人员详情项之间的间距 -->
                    <Setter Property="Margin" Value="0,0,0,0"/>
                </Style>
            </ItemsControl.ItemContainerStyle>
        </ItemsControl>
        
        <!-- Footer（底部）- 相对于整个视口定位 -->
        <TextBlock Text="{local:Localization Key=logistics.welcomesign.footer}" 
                   Style="{StaticResource WelcomeFooterStyle}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Bottom"
                   Margin="0,0,0,0"
                   Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        
        <!-- 公司 LOGO（右上角）- 相对于整个视口定位，不受 Border Padding 影响 -->
        <Image Source="/Assets/teac_white.png"
               Width="120"
               Height="120"
               HorizontalAlignment="Right"
               VerticalAlignment="Top"
               Margin="0,16,16,0"
               Stretch="Uniform"
               Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        
        <!-- ISO LOGO（右下角）- 相对于整个视口定位，不受 Border Padding 影响 -->
        <Image Source="/Assets/teac_iso.png"
               Width="180"
               Height="180"
               HorizontalAlignment="Right"
               VerticalAlignment="Bottom"
               Margin="0,0,16,16"
               Stretch="Uniform"
               Visibility="{Binding ShowVisitingInfo, Converter={StaticResource BooleanToVisibilityConverter}}"/>

        <!-- 广告视频 -->
        <Grid Visibility="{Binding ShowVisitingInfo, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <vlc:VideoView x:Name="AdVideoPlayer"
                           HorizontalAlignment="Stretch"
                           VerticalAlignment="Stretch"/>
        </Grid>
    </Grid>
    </Grid>
</UserControl>

