<UserControl x:Class="Takt.Fluent.Views.Identity.MenuView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:Takt.Fluent.Controls"
             xmlns:local="clr-namespace:Takt.Fluent.Extensions"
             xmlns:helpers="clr-namespace:Takt.Fluent.Helpers"
             xmlns:fa="clr-namespace:FontAwesome.Sharp;assembly=FontAwesome.Sharp"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d"
             d:DesignHeight="720"
             d:DesignWidth="1280">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <helpers:EmptyToVisibilityConverter x:Key="EmptyToVisibilityConverter" />
        <helpers:StringToIconCharConverter x:Key="StringToIconCharConverter" />
        <helpers:StringToTranslationConverter x:Key="StringToTranslationConverter" />
        <helpers:EnumToStringConverter x:Key="EnumToStringConverter" />

        <!-- 表头样式 -->
        <Style x:Key="MenuHeaderStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource MaterialDesignPaper}" />
            <Setter Property="BorderBrush" Value="{DynamicResource MaterialDesignDivider}" />
            <Setter Property="BorderThickness" Value="0,0,0,1" />
            <Setter Property="Padding" Value="16,8" />
        </Style>

        <!-- 树形视图项容器样式 -->
        <Style x:Key="MenuTreeViewItemStyle" TargetType="TreeViewItem">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource MaterialDesignCardBackground}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{DynamicResource AccentFillColorDefaultBrush}" />
                    <Setter Property="Foreground" Value="{DynamicResource TextOnAccentFillColorPrimaryBrush}" />
                </Trigger>
                <MultiTrigger>
                    <MultiTrigger.Conditions>
                        <Condition Property="IsSelected" Value="True" />
                        <Condition Property="IsMouseOver" Value="True" />
                    </MultiTrigger.Conditions>
                    <Setter Property="Background" Value="{DynamicResource AccentFillColorTertiaryBrush}" />
                    <Setter Property="Foreground" Value="{DynamicResource TextOnAccentFillColorPrimaryBrush}" />
                </MultiTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid x:Name="Root">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- 查询栏 -->
        <Border Grid.Row="0"
                x:Name="QueryPanel"
                Background="{DynamicResource MaterialDesignPaper}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,0,0,1"
                Padding="16,12"
                Visibility="{Binding ShowQueryArea, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBox Grid.Column="0"
                         x:Name="KeywordTextBox"
                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                         materialDesign:HintAssist.Hint="{local:Localization Key=common.placeholder.keywordHint, Param0Key=identity.menu.keyword}"
                         materialDesign:TextFieldAssist.DecorationVisibility="Collapsed"
                         Text="{Binding Keyword, UpdateSourceTrigger=PropertyChanged}"
                         Height="32"
                         Padding="12,6"
                         FontSize="13"
                         VerticalAlignment="Center"
                         VerticalContentAlignment="Center"
                         Margin="0,0,12,0">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding QueryCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                
                <Button Grid.Column="1"
                        Command="{Binding QueryCommand}"
                        Style="{StaticResource DefaultPrimarySmall}"
                        Height="32"
                        Margin="0,0,12,0"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <materialDesign:PackIcon Kind="Magnify" 
                                                 Width="18" 
                                                 Height="18" 
                                                 Margin="0,0,6,0" />
                        <TextBlock Text="{local:Localization Key=common.search}" VerticalAlignment="Center" />
                    </StackPanel>
                </Button>
                
                <Button Grid.Column="2"
                        Command="{Binding ResetCommand}"
                        Style="{StaticResource DefaultInfoSmall}"
                        Height="32"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <materialDesign:PackIcon Kind="Autorenew" 
                                                 Width="18" 
                                                 Height="18" 
                                                 Margin="0,0,6,0" />
                        <TextBlock Text="{local:Localization Key=common.reset}" VerticalAlignment="Center" />
                    </StackPanel>
                </Button>
            </Grid>
        </Border>
        
        <!-- 工具栏 -->
        <Border Grid.Row="1"
                Background="{DynamicResource MaterialDesignPaper}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="0,0,0,1"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Command="{Binding CreateCommand}"
                            Style="{StaticResource DefaultPrimarySmall}"
                            Height="32"
                            Margin="0,0,12,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Plus" 
                                                     Width="18" 
                                                     Height="18" 
                                                     Margin="0,0,6,0" />
                            <TextBlock Text="{local:Localization Key=common.button.create}" />
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding UpdateCommand}"
                            CommandParameter="{Binding SelectedMenu}"
                            Style="{StaticResource DefaultSuccessSmall}"
                            Height="32"
                            Margin="0,0,12,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Pencil" 
                                                     Width="18" 
                                                     Height="18" 
                                                     Margin="0,0,6,0" />
                            <TextBlock Text="{local:Localization Key=common.button.update}" />
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding DeleteCommand}"
                            CommandParameter="{Binding SelectedMenu}"
                            Style="{StaticResource DefaultDangerSmall}"
                            Height="32"
                            Margin="0,0,12,0">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Delete" 
                                                     Width="18" 
                                                     Height="18" 
                                                     Margin="0,0,6,0" />
                            <TextBlock Text="{local:Localization Key=common.button.delete}" />
                        </StackPanel>
                    </Button>
                    <Button x:Name="ExpandCollapseButton"
                            Style="{StaticResource DefaultIconPlainAccentSmall}"
                            Width="32"
                            Height="32"
                            Click="ExpandCollapseButton_Click">
                        <materialDesign:PackIcon x:Name="ExpandCollapseIcon"
                                                 Kind="ChevronDown" 
                                                 Width="20" 
                                                 Height="20" />
                    </Button>
                </StackPanel>
                
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center">
                    <Button Style="{StaticResource DefaultIconPlainPrimarySmall}"
                            Width="32"
                            Height="32"
                            Margin="0,0,4,0"
                            ToolTip="{local:Localization Key=common.toggleQueryBar}"
                            Click="ToggleQueryAreaButton_Click">
                        <materialDesign:PackIcon Kind="Magnify" 
                                                 Width="20" 
                                                 Height="20" />
                    </Button>
                    
                    <Button x:Name="ColumnToggleButton"
                            Style="{StaticResource DefaultIconPlainAccentSmall}"
                            Width="32"
                            Height="32"
                            Margin="0,0,4,0"
                            ToolTip="{local:Localization Key=common.toggleColumns}"
                            Click="ColumnToggleButton_Click">
                        <materialDesign:PackIcon Kind="ViewColumnOutline" 
                                                 Width="20" 
                                                 Height="20" />
                    </Button>
                    
                    <Popup x:Name="ColumnChooserPopup"
                           PlacementTarget="{Binding ElementName=ColumnToggleButton}"
                           Placement="Bottom"
                           StaysOpen="False"
                           IsOpen="{Binding IsColumnPanelOpen, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay}"
                           AllowsTransparency="True"
                           Closed="ColumnChooserPopup_Closed">
                        <Border Background="{DynamicResource MaterialDesignCardBackground}"
                                CornerRadius="6"
                                Padding="12"
                                materialDesign:ElevationAssist.Elevation="Dp4">
                            <StackPanel>
                                <TextBlock Text="{local:Localization Key=common.toggleColumns}"
                                           FontWeight="SemiBold"
                                           Margin="0,0,0,8"
                                           Foreground="{DynamicResource MaterialDesignBody}" />
                                <TextBlock Text="树形视图不支持列设置"
                                           Foreground="{DynamicResource MaterialDesignBody}"
                                           FontSize="14"
                                           Margin="0,8,0,0" />
                            </StackPanel>
                        </Border>
                    </Popup>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- 表头 -->
        <Border Grid.Row="2" Style="{StaticResource MenuHeaderStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="16"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="150"/>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="80"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="2"
                           Text="{local:Localization Key=identity.menu.menuname}"
                           FontWeight="Bold"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Grid.Column="3"
                           Text="{local:Localization Key=identity.menu.menucode}"
                           FontWeight="Bold"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Grid.Column="4"
                           Text="{local:Localization Key=identity.menu.menutype}"
                           FontWeight="Bold"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Grid.Column="5"
                           Text="{local:Localization Key=identity.menu.permcode}"
                           FontWeight="Bold"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Grid.Column="6"
                           Text="{local:Localization Key=identity.menu.ordernum}"
                           FontWeight="Bold"
                           HorizontalAlignment="Right"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Grid.Column="7"
                           Text="{local:Localization Key=identity.menu.menustatus}"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                <TextBlock Grid.Column="8"
                           Text="{local:Localization Key=common.operation}"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
            </Grid>
        </Border>
        
        <!-- 原生 TreeView -->
        <TreeView Grid.Row="3"
                  x:Name="MenuTreeView"
                  ItemsSource="{Binding Menus}"
                  SelectedItemChanged="MenuTreeView_SelectedItemChanged"
                  ItemContainerStyle="{StaticResource MenuTreeViewItemStyle}">
            <TreeView.ItemTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                    <Grid MinHeight="32" Margin="16,2,16,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="16"/>
                            <ColumnDefinition Width="200"/>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="150"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>

                        <!-- 图标 -->
                        <fa:IconBlock Grid.Column="0"
                                      Width="16"
                                      Height="16"
                                      VerticalAlignment="Center"
                                      IconFont="Solid"
                                      Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                      Icon="{Binding Icon, Converter={StaticResource StringToIconCharConverter}}"
                                      Visibility="{Binding Icon, Converter={StaticResource EmptyToVisibilityConverter}}"/>

                        <!-- 菜单名称 -->
                        <TextBlock Grid.Column="2"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}">
                            <TextBlock.Text>
                                <MultiBinding Converter="{StaticResource StringToTranslationConverter}">
                                    <Binding Path="I18nKey" />
                                    <Binding Path="MenuName" />
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>

                        <!-- 菜单编码 -->
                        <TextBlock Grid.Column="3"
                                   Text="{Binding MenuCode}"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>

                        <!-- 菜单类型 -->
                        <TextBlock Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                            <TextBlock.Text>
                                <Binding Path="MenuType" Converter="{StaticResource EnumToStringConverter}"/>
                            </TextBlock.Text>
                        </TextBlock>

                        <!-- 权限码 -->
                        <TextBlock Grid.Column="5"
                                   Text="{Binding PermCode}"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                   TextTrimming="CharacterEllipsis"/>

                        <!-- 排序号 -->
                        <TextBlock Grid.Column="6"
                                   Text="{Binding OrderNum}"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Right"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>

                        <!-- 状态 -->
                        <TextBlock Grid.Column="7"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Center"
                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}">
                            <TextBlock.Text>
                                <Binding Path="MenuStatus" Converter="{StaticResource EnumToStringConverter}"/>
                            </TextBlock.Text>
                        </TextBlock>
                        
                        <!-- 行操作按钮 -->
                        <StackPanel Grid.Column="8"
                                    Orientation="Horizontal"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center">
                            <Button Command="{Binding DataContext.UpdateCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding}"
                                    Style="{StaticResource DefaultIconPlainSuccessSmall}"
                                    ToolTip="{local:Localization Key=common.button.update}">
                                <materialDesign:PackIcon Kind="Pencil" 
                                                         Width="16" 
                                                         Height="16" />
                            </Button>
                            <Button Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                    CommandParameter="{Binding}"
                                    Style="{StaticResource DefaultIconPlainWarningSmall}"
                                    Margin="4,0,0,0"
                                    ToolTip="{local:Localization Key=common.button.delete}">
                                <materialDesign:PackIcon Kind="Delete" 
                                                         Width="16" 
                                                         Height="16" />
                            </Button>
                        </StackPanel>
                    </Grid>
                </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>
    </Grid>
</UserControl>

